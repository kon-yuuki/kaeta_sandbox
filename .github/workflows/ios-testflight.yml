name: iOS TestFlight

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: macos-15-arm64
    env:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_BUILD_PROVISION_PROFILE_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
      APP_BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
      APPLE_TEAM_ID: 8MKVD3TZQ3

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Select Xcode 26 SDK
        run: |
          XCODE_APP=$(ls -d /Applications/Xcode_26*.app 2>/dev/null | sort -V | tail -n 1)
          if [[ -z "$XCODE_APP" ]]; then
            echo "Xcode 26 not found on this runner image."
            ls -1 /Applications | grep '^Xcode' || true
            exit 1
          fi
          echo "DEVELOPER_DIR=$XCODE_APP/Contents/Developer" >> "$GITHUB_ENV"
          echo "Using $XCODE_APP"
          xcodebuild -version
          xcodebuild -showsdks | grep -E "iphoneos26|iOS 26" || true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code (build_runner)
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Compute build number
        run: |
          BUILD_NUMBER=$((20 + GITHUB_RUN_NUMBER))
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_ENV"
          echo "Using BUILD_NUMBER=$BUILD_NUMBER"

      - name: Import certificate and provisioning profile
        run: |
          if [[ -z "$BUILD_CERTIFICATE_BASE64" || -z "$P12_PASSWORD" || -z "$BUILD_PROVISION_PROFILE_BASE64" || -z "$KEYCHAIN_PASSWORD" ]]; then
            echo "Missing iOS signing secrets. Required: IOS_BUILD_CERTIFICATE_BASE64, IOS_P12_PASSWORD, IOS_BUILD_PROVISION_PROFILE_BASE64, IOS_KEYCHAIN_PASSWORD"
            exit 1
          fi
          CERT_PATH="$RUNNER_TEMP/build_certificate.p12"
          PP_PATH="$RUNNER_TEMP/build_pp.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o "$CERT_PATH"
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o "$PP_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PP_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles"

          PP_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PP_PATH" > "$PP_PLIST"
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" "$PP_PLIST")
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" "$PP_PLIST")

          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"

      - name: Build iOS artifacts (no codesign)
        run: flutter build ios --release --no-codesign --build-number "$BUILD_NUMBER"

      - name: Validate signing inputs
        run: |
          BUNDLE_ID="${APP_BUNDLE_ID:-com.kon-yuuki.kaetaSandbox}"
          PP_PLIST="$RUNNER_TEMP/profile.plist"

          PROFILE_APP_ID=$(/usr/libexec/PlistBuddy -c "Print :Entitlements:application-identifier" "$PP_PLIST")
          PROFILE_TEAM_ID=$(/usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" "$PP_PLIST")
          PROFILE_BUNDLE_ID="${PROFILE_APP_ID#*.}"

          echo "Bundle ID from workflow: $BUNDLE_ID"
          echo "Bundle ID from profile : $PROFILE_BUNDLE_ID"
          echo "Team ID from profile   : $PROFILE_TEAM_ID"
          echo "Team ID expected       : $APPLE_TEAM_ID"

          if [[ "$PROFILE_BUNDLE_ID" != "$BUNDLE_ID" ]]; then
            echo "Provisioning profile bundle id mismatch."
            exit 1
          fi

          if [[ "$PROFILE_TEAM_ID" != "$APPLE_TEAM_ID" ]]; then
            echo "Provisioning profile team id mismatch."
            exit 1
          fi

          xcodebuild -workspace ios/Runner.xcworkspace -scheme Runner -configuration Release -showBuildSettings \
            | grep -E "PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|CODE_SIGN_STYLE|CODE_SIGN_IDENTITY" || true

      - name: Archive and export IPA (manual signing)
        run: |
          BUNDLE_ID="${APP_BUNDLE_ID:-com.kon-yuuki.kaetaSandbox}"

          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            archive

          cat > "$RUNNER_TEMP/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>$APPLE_TEAM_ID</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key>
              <string>$PROFILE_NAME</string>
            </dict>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath build/ios/ipa

      - name: Resolve IPA path
        id: resolve_ipa
        run: |
          IPA_PATH=$(find build/ios/ipa -maxdepth 1 -name "*.ipa" -type f | head -n 1)
          if [[ -z "$IPA_PATH" ]]; then
            echo "No .ipa file found under build/ios/ipa"
            ls -la build/ios/ipa || true
            exit 1
          fi
          echo "path=$IPA_PATH" >> "$GITHUB_OUTPUT"
          echo "Resolved IPA: $IPA_PATH"

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ steps.resolve_ipa.outputs.path }}
          issuer-id: ${{ secrets.ASC_ISSUER_ID }}
          api-key-id: ${{ secrets.ASC_KEY_ID }}
          api-private-key: ${{ secrets.ASC_PRIVATE_KEY }}
