# 招待機能 実機検証ガイド

最終更新日: 2026-02-16

## 1. 目的
招待リンク経由の参加フローを、2台実機で再現性高く検証する。

## 2. 検証対象パターン
| パターンID | インストール状態 | ユーザー状態 | 主な確認ポイント |
|---|---|---|---|
| U1（旧P1a/P1b） | 済み | アカウントあり・オンボ未完了（ログイン状態は問わない） | 認証復帰、招待付きオンボ、参加完了 |
| P2 | 済み | アカウントあり・オンボ完了・ログイン済み・未所属 | 参加確認から即参加できる |
| P3 | 済み | アカウントあり・オンボ完了・未ログイン | ログイン後に招待復帰して参加 |
| P4a | 未インストール | 既存アカウント・オンボ完了 | Webフォールバック後に参加完了 |
| P4b | 未インストール | 既存アカウント・オンボ未完了 | Webフォールバック後に招待付きオンボ再開 |
| P5 | 未インストール | アカウントなし | 新規登録後に招待復帰して参加 |
| P6 | 済み or 未インストール | 無効招待（notFound/expired） | エラー画面遷移とコンテキストクリア |
| P7 | 済み | 別チーム所属済み | 参加拒否（alreadyHasFamily）と状態不変 |
| S8（必須） | 済み or 未インストール | 使用済みリンクを別ユーザーが利用 | 無効招待として拒否できる |

## 3. 2台構成
- 端末A: 招待発行側（owner固定）
- 端末B: 招待受信側（状態を作り替えて検証）

## 4. 事前準備チェック
1. 端末Aで `owner@test.com` ログイン済み。
2. 招待元チーム `招待テストファミリーA` が存在する。
3. P7用の別チーム `Family-B` があり、`member_other_family@test.com` が所属済み。
4. 各ケースで招待リンクを使い回さない運用にする。
5. 検証ログを `docs/invite-feature-test-log.md` に記録する。

## 5. ケース実行順（推奨）
1. U1
2. P2
3. P3
4. P4a
5. P4b
6. P5
7. P6
8. P7
9. S8

## 6. ケース開始前ルール
- 共通:
  - 端末Aは `owner` ログイン済みで、毎回新規招待リンクを発行する。
- 端末B:
  - ログイン状態をケース条件に合わせる。
  - オンボ状態をケース条件に合わせる。
  - 未インストール系（P4a/P4b/P5）はアプリ削除後に開始する。

## 7. 全ケース共通の確認ポイント
1. リンクタップ後に意図通り起動するか（ブラウザ滞留有無）。
2. 期待画面へ遷移するか。
3. 参加処理が1回で完了するか（重複参加しないか）。
4. 完了後に `current_family_id` が期待値か。
5. エラーケースで復帰導線が正しいか。

## 8. ケース別受け入れ条件（簡易）
### U1
1. 招待リンクから `参加してはじめる` 画面に到達する。
2. 未ログイン時は認証画面へ遷移し、認証後に招待導線へ戻る。
3. 招待導線オンボでは `チーム名設定` / `招待フロー` を表示しない。
4. オンボ完了で参加完了する。

### P2
前提: 対象ユーザーは参加時点で未所属（所属中はP7）。
1. 招待確認画面へ遷移する。
2. 参加操作で即参加完了する。

### P3
1. 招待リンク後にログイン画面へ遷移する。
2. ログイン後に招待コンテキストを復元し、参加完了できる。

### P4a
1. Webフォールバックが表示される。
2. TestFlight/App Store導線からインストール・ログイン後に参加完了できる。

### P4b
1. Webフォールバック表示後、インストール・ログインで招待付きオンボを再開できる。
2. オンボ完了で参加完了する。

### P5
1. 未登録ユーザーが新規登録後、招待コンテキストを復元して参加完了できる。

### P6
1. 無効リンクで `招待リンクエラー` に遷移する。
2. `pending_invite_id` がクリアされる。

### P7
1. 別チーム所属ユーザーは `alreadyHasFamily` で参加拒否される。
2. 既存所属は変化しない。

### S8
1. ユーザーAでリンク使用後、同リンクをユーザーBで開く。
2. 無効招待エラーへ遷移する。
3. 可能なら計測イベント `invite_invalid_*` を確認する。

## 9. ケース間リセット
1. 端末Bをログアウトする。
2. 必要時はアプリ削除/再インストールする。
3. 招待コンテキストが残っていないことを確認する。
4. 次ケース用の新規招待リンクを発行する。

## 10. 関連ドキュメント
- 仕様本体: `docs/invite-feature-spec.md`
- テストアカウント一覧: `docs/invite-feature-test-accounts.md`
- 実機検証ログ: `docs/invite-feature-test-log.md`
