# 招待機能 実機検証ログ

最終更新日: 2026-02-16

## 1. 検証パターン一覧
| パターンID | 実施状態 | インストール状態 | アカウント状態 | オンボ状態 | ログイン状態 | 所属状態 | 主な確認ポイント |
|---|---|---|---|---|---|---|---|
| U1（旧P1a/P1b） | A/B | 済み | あり | 未完了 | 未ログイン（認証遷移前提） | 未所属 | `参加する` 後に認証へ遷移し、招待付きオンボを再開して参加完了できる |
| P2 | A/B | 済み | あり | 完了 | ログイン済み | 未所属 | 参加確認から即参加できる |
| P3 | A/B | 済み | あり | 完了 | 未ログイン | 未所属 | `参加してはじめる` 押下後に既存アカウントログインページへ遷移し、ログイン成功後は再オンボせず招待コンテキスト復帰で参加完了 |
| P4a | A/B | 未インストール | 既存あり | 完了 | 未ログイン（初回起動時） | 未所属 | Webフォールバック後に参加完了 |
| P4b | A/B | 未インストール | 既存あり | 未完了 | 未ログイン（初回起動時） | 未所属 | Webフォールバック後に招待付きオンボ再開 |
| P5 | A/B | 未インストール | なし | - | - | - | 新規登録後に招待復帰して参加 |
| P6 | A/B | 済み or 未インストール | あり/なし | - | - | - | 無効招待（notFound/期限切れ）でエラー画面遷移とコンテキストクリア |
| P7 | A/B | 済み | あり | 完了 | ログイン済み/未ログイン | 別チーム所属済み | 参加拒否（alreadyHasFamily）と状態不変 |
| S8（必須） | A/B | 済み or 未インストール | あり/なし | - | - | - | 使用済みリンクの再使用を拒否できる（期限切れは P6 で検証） |

注記: 現実装ではアカウント作成時にチーム作成されるため、「オンボ未完了かつ家族未所属」は原則起こり得ない。

## 2. アプリ状態パターン（実施対象）
| 実行ID | アプリ状態 | 定義 | 優先度 |
|---|---|---|---|
| A | バックグラウンド | アプリは終了していないが画面は前面にない状態 | 高 |
| B | 停止（タスクキル後） | アプリプロセスが完全終了した状態 | 高 |

運用ルール:
1. 各ケースは原則 `A` と `B` の両方で実施する。
2. 片方のみ実施の場合は、未実施理由を備考に残す。

## 3. 記録テンプレート
- ケースID:
- 実行ID（A/B）:
- 実施日時:
- 端末OS / アプリ版:
- 事前状態（インストール/ログイン/オンボ）:
- 実施結果: Pass / Fail
- 失敗時の事象:
- スクリーンショット or 動画:
- 備考（再現条件、回避策）:

## 4. 実績
| ケースID | 実行ID | 実施日 | 結果 | 観測内容 |
|---|---|---|---|---|
| U1（旧P1a/P1b） | A | 2026-02-16 | Pass | `チームに参加` クリック後に認証画面へ遷移。認証後、`チーム名設定` と `招待フロー` を省略した招待付きオンボーディングを経由して参加完了。 |
| U1（旧P1a/P1b） | B | 2026-02-16 | Pass | 招待リンクから開始し、`参加する` 押下後に認証導線を経由。`チームを作成` ステップを省いたオンボーディング最終確認まで到達し、参加完了。 |
| P2 | A | 2026-02-16 | Pass | ブラウザ遷移後に「Kaetaで開きますか？」をタップ。`参加してはじめる` 押下後、即時に参加済み状態となりホームへ遷移。 |
| P2 | B | 2026-02-16 | Pass | ブラウザ遷移後に「Kaetaで開きますか？」をタップ。`参加してはじめる` 押下後、即時に参加済み状態となりホームへ遷移。 |
| P3 | A | 2026-02-16 | Fail | 既存アカウント・オンボ完了・未ログイン状態で `参加してはじめる` 押下後、既存ログイン導線ではなく `チームを作成してはじめる` 側へ遷移し、再オンボ導線に入る。 |
| P4a | A | 2026-02-16 | Fail | 招待リンクタップ → Webフォールバック（TestFlight導線）→ アプリインストール後に再度リンク遷移で `参加してはじめる` へ到達。ただし `参加してはじめる` 押下後に `チームを作成してはじめる` へ遷移し、再オンボが必要になった。 |
| P4b | A | 2026-02-16 | Pass | P4aと同様にWebフォールバック経由で復帰。オンボ未完了ユーザーとして通常オンボを実施し、最終的に招待チームへ参加完了。 |
| S8 | A | 2026-02-16 | Pass | 使用済みリンクをタップ後、招待エラーページへ遷移。期待どおり参加不可。 |
| S8 | B | 2026-02-16 | Pass | アプリ停止（タスクキル）状態で使用済みリンクをタップ後、招待エラーページへ遷移。期待どおり参加不可。 |
| P7 | A | 2026-02-16 | Pass | リンククリックで `参加してはじめる` へ遷移。`参加してはじめる` 押下時に「すでに別のチームに参加しています。」のスナックバー表示。想定どおり参加拒否。 |
| P7 | B | 2026-02-16 | Pass | リンククリック → ブラウザ起動 → 「このページをKaetaで開きますか？」モーダルで `開く` を押下 → `参加してはじめる` へ遷移。`参加してはじめる` 押下時に「すでに別のチームに参加しています。」のスナックバー表示。想定どおり参加拒否。 |

## 5. 検証途中メモ（継続）
- 記録日: 2026-02-16
- 状態: 検証は途中。続きは翌日に実施予定。
- 追加で確認された不具合:
  - オーナーがチーム削除後、他メンバー側の `profiles.current_family_id` が即時に整合しないケースを確認。
  - Supabase上では `families` の行が削除済みでも、他メンバーが削除済みチーム所属に見える不整合が発生。
- 対応状況:
  - アプリ側 `deleteFamily()` は修正済み（削除対象チームの全メンバー `currentFamilyId` を先に `null` 化）。
  - DB側ガード（`profiles.current_family_id -> families.id ON DELETE SET NULL`）は適用確認が未完了。
- 未完了タスク:
  - チーム削除整合性の再検証（削除後、全メンバーで状態反映を確認）。
  - P7/P2/P3 など残ケースの継続検証。
