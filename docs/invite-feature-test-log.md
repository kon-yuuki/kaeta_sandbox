# 招待機能 実機検証ログ

最終更新日: 2026-02-19

## 1. 検証パターン一覧
| パターンID | 実施状態 | インストール状態 | アカウント状態 | オンボ状態 | ログイン状態 | 所属状態 | 主な確認ポイント |
|---|---|---|---|---|---|---|---|
| U1（旧P1a/P1b） | A/B | 済み | あり | 未完了 | 未ログイン（認証遷移前提） | 未所属 | `参加する` 後に認証へ遷移し、招待付きオンボを再開して参加完了できる |
| P2 | A/B | 済み | あり | 完了 | ログイン済み | 未所属 | 参加確認から即参加できる |
| P3 | A/B | 済み | あり | 完了 | 未ログイン | 未所属 | `参加してはじめる` 押下後に既存アカウントログインページへ遷移し、ログイン成功後は再オンボせず招待コンテキスト復帰で参加完了 |
| P4a | A/B | 未インストール | 既存あり | 完了 | 未ログイン（初回起動時） | 未所属 | Webフォールバック後に参加完了 |
| P4b | A/B | 未インストール | 既存あり | 未完了 | 未ログイン（初回起動時） | 未所属 | Webフォールバック後に招待付きオンボ再開 |
| P5 | A/B | 未インストール | なし | - | - | - | 新規登録後に招待復帰して参加 |
| P6 | A/B | 済み or 未インストール | あり/なし | - | - | - | 無効招待（notFound/期限切れ）でエラー画面遷移とコンテキストクリア |
| P7 | A/B | 済み | あり | 完了 | ログイン済み/未ログイン | 別チーム所属済み | 参加拒否（alreadyHasFamily）と状態不変 |
| S8（必須） | A/B | 済み or 未インストール | あり/なし | - | - | - | 使用済みリンクの再使用を拒否できる（期限切れは P6 で検証） |

注記: 現実装ではアカウント作成時にチーム作成されるため、「オンボ未完了かつ家族未所属」は原則起こり得ない。

## 2. アプリ状態パターン（実施対象）
| 実行ID | アプリ状態 | 定義 | 優先度 |
|---|---|---|---|
| A | バックグラウンド | アプリは終了していないが画面は前面にない状態 | 高 |
| B | 停止（タスクキル後） | アプリプロセスが完全終了した状態 | 高 |

運用ルール:
1. 各ケースは原則 `A` と `B` の両方で実施する。
2. 片方のみ実施の場合は、未実施理由を備考に残す。

## 3. 記録テンプレート
- ケースID:
- 実行ID（A/B）:
- 実施日時:
- 端末OS / アプリ版:
- 事前状態（インストール/ログイン/オンボ）:
- 実施結果: Pass / Fail
- 失敗時の事象:
- スクリーンショット or 動画:
- 備考（再現条件、回避策）:

## 4. 実績
| ケースID | 実行ID | 実施日 | 結果 | 観測内容 |
|---|---|---|---|---|
| U1（旧P1a/P1b） | A | 2026-02-16 | Pass | `チームに参加` クリック後に認証画面へ遷移。認証後、`チーム名設定` と `招待フロー` を省略した招待付きオンボーディングを経由して参加完了。 |
| U1（旧P1a/P1b） | B | 2026-02-16 | Pass | 招待リンクから開始し、`参加する` 押下後に認証導線を経由。`チームを作成` ステップを省いたオンボーディング最終確認まで到達し、参加完了。 |
| P2 | A | 2026-02-16 | Pass | ブラウザ遷移後に「Kaetaで開きますか？」をタップ。`参加してはじめる` 押下後、即時に参加済み状態となりホームへ遷移。 |
| P2 | B | 2026-02-16 | Pass | ブラウザ遷移後に「Kaetaで開きますか？」をタップ。`参加してはじめる` 押下後、即時に参加済み状態となりホームへ遷移。 |
| P3 | A | 2026-02-16 | Fail | 既存アカウント・オンボ完了・未ログイン状態で `参加してはじめる` 押下後、既存ログイン導線ではなく `チームを作成してはじめる` 側へ遷移し、再オンボ導線に入る。 |
| P4a | A | 2026-02-16 | Fail | 招待リンクタップ → Webフォールバック（TestFlight導線）→ アプリインストール後に再度リンク遷移で `参加してはじめる` へ到達。ただし `参加してはじめる` 押下後に `チームを作成してはじめる` へ遷移し、再オンボが必要になった。 |
| P4a | A | 2026-02-19 | Fail（再現更新） | ブラウザ起動 → TestFlightからインストール → `招待された方はこちら` でリンク入力 → `すでにアカウントをお持ちの方` でログイン成功。ただし招待参加に復帰せず、チーム未参加のまま。 |
| P4b | A | 2026-02-16 | Pass | P4aと同様にWebフォールバック経由で復帰。オンボ未完了ユーザーとして通常オンボを実施し、最終的に招待チームへ参加完了。 |
| S8 | A | 2026-02-16 | Pass | 使用済みリンクをタップ後、招待エラーページへ遷移。期待どおり参加不可。 |
| S8 | B | 2026-02-16 | Pass | アプリ停止（タスクキル）状態で使用済みリンクをタップ後、招待エラーページへ遷移。期待どおり参加不可。 |
| P7 | A | 2026-02-16 | Pass | リンククリックで `参加してはじめる` へ遷移。`参加してはじめる` 押下時に「すでに別のチームに参加しています。」のスナックバー表示。想定どおり参加拒否。 |
| P7 | B | 2026-02-16 | Pass | リンククリック → ブラウザ起動 → 「このページをKaetaで開きますか？」モーダルで `開く` を押下 → `参加してはじめる` へ遷移。`参加してはじめる` 押下時に「すでに別のチームに参加しています。」のスナックバー表示。想定どおり参加拒否。 |
| P3 | A | 2026-02-19 | Fail | 再検証で招待リンクをタップ後、ブラウザで「このページは開けません」と表示され、アプリ遷移前に失敗。 |
| P3 | A | 2026-02-19 | Fail（継続） | DNS/ドメイン設定確認中に、Chromeで `kaeta-jointeam.com` が「危険なサイト」警告表示（Safe Browsing）。Search Consoleのドメイン確認（TXT）を設定したが、反映待ちのため本日中の再検証は保留。 |
| P3 | A | 2026-02-19 | Fail（再現更新） | 招待リンクタップでブラウザ自動起動。`アプリで開く` から `参加してはじめる` へ遷移し、`すでにアカウントをお持ちの方` でログインまでは成功。ただしログイン後に招待参加が実行されず、チーム未参加のまま。 |

## 5. 検証途中メモ（継続）
- 記録日: 2026-02-16
- 状態: 検証は途中。続きは翌日に実施予定。
- 追加で確認された不具合:
  - オーナーがチーム削除後、他メンバー側の `profiles.current_family_id` が即時に整合しないケースを確認。
  - Supabase上では `families` の行が削除済みでも、他メンバーが削除済みチーム所属に見える不整合が発生。
  - P3再検証時に、招待リンクタップ後ブラウザで「このページは開けません」が表示されるケースを確認（アプリ未遷移）。
  - P3再々検証で、ログイン後に招待コンテキストへ復帰せず参加未完了になる不具合を確認（`既存アカウントログイン画面` 経由時）。
  - P4a再検証でも同様に、既存アカウントログイン成功後に招待参加へ復帰せず未参加となる事象を確認（P3と同系統）。
- 対応状況:
  - アプリ側 `deleteFamily()` は修正済み（削除対象チームの全メンバー `currentFamilyId` を先に `null` 化）。
  - DB側ガード（`profiles.current_family_id -> families.id ON DELETE SET NULL`）は適用確認が未完了。
  - 原因調査で、`/invite/*` のWebフォールバック実体（HTML/Workerルート）がリポジトリ上に未配置であることを確認。Universal Link失敗時にブラウザエラーとなる可能性あり。
  - Cloudflare DNSは確認済み。`NS(dnsv.jp)` レコードは削除対応。
  - お名前.com側のNS委任先設定をCloudflareへ変更済み。浸透待ち。
  - Search Console用TXT（`google-site-verification`）設定済み。所有権確認は反映待ち。
  - P3不具合の原因を特定。`ExistingAccountLoginPage` がログイン成功時に pending invite を見ず `popUntil(first)` しており、招待参加フローへ戻らない。
  - 2026-02-19実装反映:
    - `InviteStartPage` の未ログイン遷移先を `InviteAuthStartPage`（新規追加）へ変更。
    - 参加用認証開始ページ（`チームに参加してはじめる`）を追加。`すでにアカウントをお持ちの方はこちら` 動線を常設。
    - `ExistingAccountLoginPage` はログイン後に pending invite があれば `InviteStartPage` へ復帰するよう修正済み。
- 未完了タスク:
  - チーム削除整合性の再検証（削除後、全メンバーで状態反映を確認）。
  - P7/P2/P3 など残ケースの継続検証。
  - Safe Browsing警告解除のため、Search Console所有権確認完了後に再審査を申請。
  - Workerの招待フォールバックを「自動遷移なし（ボタン起動）」版へ切替し再デプロイ。
  - 実機確認（方針どおり動くか）:
    - 既存アカウント/オンボ完了: 参加導線でログイン後に参加完了（再オンボなし）
    - 既存アカウント/オンボ未完了: 参加用オンボ（チーム名・招待ステップなし）経由で参加
    - 新規アカウント: 参加用オンボ（チーム名・招待ステップなし）経由で参加
