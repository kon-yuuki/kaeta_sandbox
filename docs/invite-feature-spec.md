# 招待機能 仕様整理（目標 / 現状）

作成日: 2026-02-14

## 1. 目的
招待リンク経由でチーム参加を完了し、初回ユーザーが迷わず利用開始できる状態にする。

## 2. 対象範囲
- 招待リンクの発行
- リンクタップ時の遷移（Universal Links / カスタムスキーム）
- 招待参加画面
- 招待ユーザー向けオンボーディング
- 参加確定処理
- 未インストール時の導線（Webフォールバック）

## 3. 目指す仕様（To-Be）
| 項目 | 目指す仕様 |
|---|---|
| 招待リンク形式 | `https://kaeta-jointeam.com/invite/{inviteId}` を発行 |
| アプリインストール済み（iOS） | リンクタップでブラウザを挟まずアプリ起動、招待参加画面へ遷移 |
| 招待参加画面 | チーム名・招待者名を表示し、`参加してはじめる` で次に進める |
| 招待ユーザーのオンボーディング | `ユーザー情報 → アイコン設定 → 通知設定`（`家族を招待` は表示しない） |
| 招待参加確定 | オンボーディング完了時に `family_members` へ参加登録し、`profiles.current_family_id` を更新 |
| 招待リンク無効化 | 参加成功時に該当 `inviteId` を無効化（削除） |
| 未インストール時 | 招待URLから TestFlight（公開後は App Store）へ遷移できる |
| フォールバック | Universal Linkが失敗する環境向けに `kaeta://invite/{inviteId}` でも参加可能 |

## 4. 現状仕様（As-Is）
### 4.1 対象条件パターン（整理用）
> 最新運用では、オンボーディング未完了ユーザーはログイン状態で分岐せず `U1` に統合する。
> 旧 `P1a` / `P1b` はトレーサビリティのため `U1` に読み替える。
> 現実装では、アカウント作成時にチーム作成が入るため「オンボ未完了かつ家族未所属」は原則発生しない（検証時は `P7` 扱いで確認）。

| パターンID | アプリインストール | アカウント状態 | オンボーディング状態 | ログイン状態 | 想定 |
|---|---|---|---|---|---|
| U1（旧P1a/P1b） | 済み | あり | 未完了 | 問わない | 実装上は原則 `P7` に吸収されるため、非現実ケース（参考扱い） |
| P2 | 済み | あり | 完了 | ログイン済み | すぐ参加確認して参加完了（前提: 参加時点で未所属） |
| P3 | 済み | あり | 完了 | 未ログイン | ログイン後に参加完了 |
| P4a | 未インストール | あり | 完了 | 未ログイン（インストール直後想定） | ログイン後に参加確認して参加完了 |
| P4b | 未インストール | あり | 未完了 | 未ログイン（インストール直後想定） | ログイン後に招待付きオンボーディングを再開して参加完了 |
| P5 | 未インストール | なし | - | - | 新規登録後に招待復帰して参加完了 |
| P6 | 済み or 未インストール | あり or なし | - | - | 無効招待としてエラー導線へ遷移 |
| P7 | 済み | あり | 完了 | ログイン済み or 未ログイン | 既に別チーム所属のため参加不可を案内 |

### 4.2 パターン別フロー（現時点）
#### U1（旧P1a/P1b）: アプリインストール済み / アカウントあり / オンボーディング未完了 / ログイン状態は問わない
1. 招待リンク（`https://kaeta-jointeam.com/invite/{inviteId}`）をタップ
2. いったんブラウザへ遷移
3. ブラウザ上で「kaeta sandbox で開きますか？」ダイアログ表示
4. `はい` を押下するとアプリ起動
5. `参加してはじめる` ページへ遷移
6. `参加してはじめる` 押下時に未認証ならログイン画面へ遷移し、認証後に招待コンテキストを復元
7. 招待付きオンボーディング開始（`チーム名設定` と `招待フロー` はスキップ）
8. 初期設定完了後、招待されたチームに参加済み状態で開始

#### P2: アプリインストール済み / アカウントあり / オンボーディング完了 / ログイン済み（要確認）
1. 招待リンクをタップ
2. アプリ起動
3. 招待参加確認画面（または参加開始画面）へ遷移
4. 参加操作で即時参加完了
5. 参加後のホーム（対象チーム）へ遷移

#### P3: アプリインストール済み / アカウントあり / オンボーディング完了 / 未ログイン（要確認）
1. 招待リンクをタップ
2. アプリ起動
3. ログイン画面へ遷移
4. ログイン成功後、招待コンテキストを復元
5. 招待参加確認画面を経由して参加完了

#### P4a: アプリ未インストール / アカウントあり / オンボーディング完了（要確認）
1. 招待リンクをタップ
2. Webフォールバック表示
3. TestFlight（公開後はApp Store）へ誘導
4. 初回起動後にログイン
5. 招待コンテキストを復元
6. 招待参加確認画面へ遷移
7. 参加完了

#### P4b: アプリ未インストール / アカウントあり / オンボーディング未完了（要確認）
1. 招待リンクをタップ
2. Webフォールバック表示
3. TestFlight（公開後はApp Store）へ誘導
4. 初回起動後にログイン
5. 招待コンテキストを復元
6. 招待付きオンボーディングを再開
7. 初期設定完了後に参加完了

#### P5: アプリ未インストール / アカウントなし（要確認）
1. 招待リンクをタップ
2. Webフォールバック表示
3. TestFlight（公開後はApp Store）へ誘導
4. 初回起動後に新規登録（アカウント作成）
5. `招待された方はこちら` で招待リンクを貼り付け、招待コンテキストを復元
6. 招待導線オンボーディングを実施
7. 参加完了

#### P6: 無効招待（存在しない/期限切れ）（一部実装済み）
1. 招待リンクをタップ
2. 招待情報取得時に `notFound` または `expired` を検出
3. `招待リンクエラー` 画面へ固定遷移
4. 保持中の招待IDはクリア
5. ユーザーはトップへ戻る導線で離脱または再招待を待つ

#### P7: 既に別チーム所属（要確認）
1. 招待リンクをタップ
2. `参加してはじめる` を押下
3. 参加処理で `alreadyHasFamily` を検出
4. 「すでに別のチームに参加しています」メッセージを表示
5. 現在のチーム状態は変更しない

### 4.3 実装状況サマリ
| 項目 | 現状 |
|---|---|
| 招待リンク発行 | 実装済み。`families_repository.dart` で `https://kaeta-jointeam.com/invite/{id}` を生成 |
| 招待情報取得 | 実装済み。`invitations` をSupabaseから取得し期限チェック |
| アプリ内遷移 | 実装済み。`AppLinkHandler` で `inviteId` を拾い `InviteStartPage` へ遷移 |
| 招待参加画面 | 実装済み。`InviteStartPage` でチーム名/招待者表示、`参加してはじめる` あり |
| 招待オンボーディング | 実装済み。`OnboardingFlow` で招待時は3ステップ表示、`TeamInviteStep` 除外 |
| 参加確定 | 実装済み。オンボーディング完了時に `joinFamily(familyId, inviteId)` を実行 |
| カスタムスキーム | 実装済み。`kaeta://invite/{id}` をInfo.plistに設定、アプリ側で受信対応 |
| AASA配信ファイル | リポジトリ内 `deeplink_hosting` に定義あり（`/.well-known` と root） |
| 未インストール導線 | アプリコード側では未対応。Web側（Cloudflare Worker）実装が必要 |

### 4.4 パターン別ステータス（コード/実機）
| パターンID | コード実装 | 実機確認 |
|---|---|---|
| U1（旧P1a/P1b） | 実装済み | 未確認 |
| P2 | 実装済み | 未確認 |
| P3 | 実装済み | 未確認 |
| P4a | 実装済み | 未確認 |
| P4b | 実装済み | 未確認 |
| P5 | 実装済み | 未確認 |
| P6 | 実装済み | 未確認 |
| P7 | 実装済み | 未確認 |

### 4.5 特殊ケース（例外・境界）
| ケースID | ケース | 想定される状況 | 期待動作 |
|---|---|---|---|
| S1 | 招待リンク再利用 | 参加済み/無効化済みリンクを再タップ | 無効招待としてエラー導線へ遷移 |
| S2 | 同一チーム再招待 | すでに同じチーム所属ユーザーが再度招待リンクを開く | 重複参加せず、参加済み扱いまたは案内表示 |
| S3 | 招待リンク破損 | `inviteId` 欠損・不正形式・余計な文字列 | エラー表示し、通常導線へ戻せる |
| S4 | 通信失敗 | 招待取得/参加処理時にネットワーク不安定 | 招待IDを保持し、再試行可能 |
| S5 | 認証切れ | アカウントはあるがセッション失効/ログイン失敗 | 再ログイン後に招待導線へ復帰 |
| S6 | 複数招待競合 | Aリンク受信後にBリンク受信 | 優先ルールに従い1つに決定し案内 |
| S7 | チーム状態変化 | 招待後にチーム削除/参加不可状態へ変更 | 参加不可を表示し、再招待依頼導線を出す |
| S8 | 使用済み招待リンクを別ユーザーが利用 | ユーザーA参加後、同じリンクをユーザーBがタップ | 無効招待としてエラー導線へ遷移（`used` を区別できない実装では `notFound/expired` 扱い） |

## 5. 既知のギャップ / リスク
| ID | 内容 | 影響 | 優先度 |
|---|---|---|---|
| G-01 | `https` タップ時に一部環境でブラウザ滞留（特にアプリ内ブラウザ） | 参加率低下 | 高 |
| G-02 | `/invite/*` のWebレスポンスが単純文言のみだと、未インストール時の導線がない | 新規流入損失 | 高 |
| G-03 | Android `assetlinks.json` が空 | Android App Links未整備 | 中 |
| G-04 | Universal LinkのOSキャッシュにより設定変更反映が遅延 | 検証混乱 | 中 |

## 6. 実装済みコードの主な参照先
- `lib/data/repositories/families_repository.dart`
- `lib/core/app_link_handler.dart`
- `lib/pages/invite/view/invite_start_screen.dart`
- `lib/pages/invite/providers/invite_flow_provider.dart`
- `lib/pages/onboarding/onboarding_flow.dart`
- `lib/pages/onboarding/widgets/profile_setup_step.dart`
- `lib/pages/onboarding/widgets/team_invite_step.dart`
- `lib/pages/onboarding/widgets/complete_step.dart`
- `ios/Runner/Runner.entitlements`
- `ios/Runner/Info.plist`
- `deeplink_hosting/.well-known/apple-app-site-association`
- `deeplink_hosting/apple-app-site-association`
- `deeplink_hosting/_headers`

## 7. 残タスク（推奨）
1. Cloudflare Worker（`/invite/*`）にフォールバックHTMLを実装する。
2. フォールバックで `kaeta://invite/{id}` を試し、失敗時に TestFlight へ遷移する。
3. TestFlight公開後、外部テスターで以下をE2E確認する。

## 8. 検証ドキュメント
検証に必要な情報は以下へ分離した。

- 実機検証ガイド（手順・順番・受け入れ条件）: `docs/invite-feature-test-guide.md`
- テストアカウント一覧: `docs/invite-feature-test-accounts.md`
- 実機検証ログ: `docs/invite-feature-test-log.md`

## 9. セキュリティメモ
- セキュリティ懸念と後対応タスクは `docs/security-risk-memo.md` を参照。

## 付録A. 招待文面サンプル
買い物メモアプリで一緒にリストを共有しましょう！
こちらのリンクから家族グループ「実家」に参加できます。

https://kaeta-jointeam.com/invite/61dab971-de89-4c4f-9c4e-22a813b492e5

開けない場合: kaeta://invite/61dab971-de89-4c4f-9c4e-22a813b492e5

有効期限: 2026/2/21 16:29
